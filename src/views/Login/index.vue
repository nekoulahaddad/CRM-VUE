<template>
  <div class="login-wrapper">
    <div class="login-page">
      <div class="login-page__left">
        <img src="@/assets/icons/building.svg" alt="" />
      </div>
      <div class="login-page__right">
        <div v-if="!isForget" class="login-page__panel panel">
          <div class="panel__inner">
            <div class="panel__header">
              <div class="panel__title">
                –†–∞–±–æ—Ç–∞ –≤ CRM —Å–∏—Å—Ç–µ–º–µ –¶–°–ö –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∞–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
              </div>
            </div>
            <div class="panel__body">
              <div class="panel__left">
                <ul>
                  <li>–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∫–æ–º–ø–∞–Ω–∏–∏</li>
                  <li>–í–µ—Å—Ç–∏ —É—á–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã</li>
                  <li>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–æ–≤–∞—Ä–∞–º–∏</li>
                  <li>
                    –û—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã –æ—Ç–¥–µ–ª–æ–≤ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
                    –≤—Ä–µ–º–µ–Ω–∏
                  </li>
                  <li>–û—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∫–æ–º–ø–∞–Ω–∏–∏</li>
                  <li>–ü—Ä–æ–≤–æ–¥–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏</li>
                  <li>–†–∞–∑–º–µ—â–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∞–∫–∞–Ω—Å–∏—è–º–∏</li>
                  <li>–ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å SEO –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º Yandex –∏ Google</li>
                  <li>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—Ä—è–º—ã–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏</li>
                  <li>–°—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞ –∫–æ—Ä. —Å–∞–π—Ç–∞—Ö –∞ —Ç–∞–∫ –∂–µ –∏—Ö —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</li>
                </ul>
                <div class="panel__slogan">
                  –¢–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–∞—è –≤ –∫–æ–º–∞–Ω–¥–µ –º—ã —Å–º–æ–∂–µ–º –¥–æ–±–∏—Ç—å—Å—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                  üëç
                </div>
              </div>
              <div class="panel__right panel-right">
                <div class="panel-right__logo">
                  <img src="@/assets/icons/logo_big.svg" alt="" />
                </div>
                <div class="panel-right__slogan">
                  –í–º–µ—Å—Ç–µ –º—ã —Å–º–æ–∂–µ–º —Å—Ç–∞—Ç—å <span class="text--red">–ª—É—á—à–µ!</span>
                </div>
                <form class="panel-right__form" @submit.prevent="onSubmit">
                  <div class="panel-right__col">
                    <input
                      type="text"
                      class="input-login"
                      v-model="phoneNumber"
                      maxlength="20"
                      placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
                    />
                    <img src="@/assets/icons/phone.svg" alt="" />
                  </div>
                  <div class="panel-right__col">
                    <input
                      type="password"
                      name="password"
                      v-model="password"
                      @change="onChange($event)"
                      :disabled="isFetch"
                      class="input-password"
                      placeholder="–ü–∞—Ä–æ–ª—å"
                    />
                  </div>
                  <div class="policy">
                    <input type="checkbox" v-model="isPolicy" />
                    <label>
                      –Ø –¥–∞—é —Å–≤–æ—ë —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω–Ω—ã—Ö –≤
                      —Å–æ–æ—Ç–≤–µ—Ç—Å–≤–∏–∏ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —É—Å–ª–æ–≤–∏—è–º–∏
                      –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    </label>
                  </div>
                  <v-button :disabled="isFetch" red>–í–æ–π—Ç–∏</v-button>
                  <span
                    @click="isForget = true"
                    class="panel-right__forgot-password"
                  >
                    –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?
                  </span>
                </form>
              </div>
            </div>
            <div class="panel__footer">
              ¬© 2021 - 2022 –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã –û–û–û –¢–æ—Ä–≥–æ–≤—ã–π –¥–æ–º ‚Äú–¶–°–ö‚Äù
            </div>
          </div>
        </div>

        <!-- –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å -->
        <div v-else class="panel__right panel-right panel-right--forgot">
          <div class="panel-right__inner">
            <div class="panel-right__logo">
              <img src="@/assets/icons/logo_big.svg" alt="" />
            </div>
            <div class="panel-right__slogan">–û—Ç–ø—Ä–∞–≤–∏–º –ø–∞—Ä–æ–ª—å –ø–æ —Å–º—Å!</div>
            <div class="panel-right__slogan-secondary">
              –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –≤–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–∞—Ä–æ–ª—è, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä
              —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            </div>
            <form class="panel-right__form" @submit.prevent="onSubmitForget">
              <div class="panel-right__col">
                <input
                  type="text"
                  class="input-login"
                  v-model="phoneNumberForgot"
                  maxlength="20"
                  placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
                />
                <img src="@/assets/icons/phone.svg" alt="" />
              </div>
              <div class="policy">
                <input type="checkbox" v-model="isPolicy" />
                <label>
                  –Ø –¥–∞—é —Å–≤–æ—ë —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω–Ω—ã—Ö –≤
                  —Å–æ–æ—Ç–≤–µ—Ç—Å–≤–∏–∏ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —É—Å–ª–æ–≤–∏—è–º–∏
                  –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                </label>
              </div>
              <v-button :disabled="isFetch" red>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</v-button>
              <span
                class="panel-right__forgot-password"
                @click="isForget = false"
              >
                –í–æ–π—Ç–∏
              </span>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import VButton from "@/components/VButton";
import axios from "@/api/axios";
import PhoneMaskInput from "vue-phone-mask-input";

export default {
  data() {
    return {
      login: "",
      password: "",
      forgotLogin: "",
      isForget: false,
      isPolicy: false,
      isFetch: false,
      isValidNumber: false,
    };
  },
  watch: {
    isForget() {
      this.isPolicy = false;
    },
  },
  components: { VButton, PhoneMaskInput },
  computed: {
    phoneNumber: {
      get() {
        if (this.login.length) {
          this.login = this.login.replace(/[^0-9\+]/g, "");

          if (!this.login.startsWith("+")) {
            this.login = `+${this.login}`;
          }

          if (this.login.startsWith("++")) {
            this.login = this.login.replace(/^./, "");
          }
        }
        return this.login;
      },
      set(v) {
        this.login = v;
      },
    },
    phoneNumberForgot: {
      get() {
        if (this.forgotLogin.length) {
          this.forgotLogin = this.forgotLogin.replace(/[^0-9\+]/g, "");

          if (!this.forgotLogin.startsWith("+")) {
            this.forgotLogin = `+${this.forgotLogin}`;
          }

          if (this.forgotLogin.startsWith("++")) {
            this.forgotLogin = this.forgotLogin.replace(/^./, "");
          }
        }
        return this.forgotLogin;
      },
      set(v) {
        this.forgotLogin = v;
      },
    },
  },
  methods: {
    onSubmit() {
      if (!this.isPolicy) {
        this.$toast.error(
          "–í—ã –Ω–µ –¥–∞–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
        );
      } else {
        this.isFetch = true;
        this.$store
          .dispatch("login", {
            login: this.login,
            password: this.password,
          })
          .then((res) => {
            if (res.status === 200) {
              this.$router.push({ name: "desktop" });
            }
          })
          .catch(() => {
            this.isFetch = false;
          });
      }
    },
    onSubmitForget() {
      if (!this.isPolicy) {
        this.$toast.error(
          "–í—ã –Ω–µ –¥–∞–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
        );
      } else {
        this.isFetch = true;
        axios
          .post("/user/resetpass", {
            login: this.forgotLogin,
          })
          .then(() => {
            this.$toast.success("–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –í–∞–º –ø–æ —Å–º—Å!");
            this.isForget = false;
            this.login = this.forgotLogin;
            this.password = "";
          })
          .catch((err) => {
            if (err.response.status === 404) {
              this.$toast.error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            }
          })
          .finally(() => {
            this.isFetch = false;
          });
      }
    },
    onChange(e) {
      this[e.target.name] = e.target.value;
    },
    onValidate({ isValidByLibPhoneNumberJs }) {
      this.isValidNumber = isValidByLibPhoneNumberJs;
    },
    getPhoneNumberFormat(str) {
      if (!this.isValidNumber) {
        return null;
      }
      let cleaned = ("" + str).replace(/\D/g, "");

      //Check if the input is of correct length
      let match = cleaned.match(/^(\d)(\d{3})(\d{3})(\d{2})(\d{2})$/);

      if (match) {
        return (
          "+" +
          match[1] +
          " " +
          match[2] +
          " " +
          match[3] +
          " " +
          match[4] +
          " " +
          match[5]
        );
      }

      return null;
    },
  },
};
</script>

<style lang="scss">
@import "@/styles/_variables";

body {
  background-color: #ecd9db;
}

.login-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  height: 100%;
  display: flex;
  background-color: #ecd9db;
  width: 1920px;
  margin: auto;

  @media (max-width: 1440px) {
    width: 100%;
  }
}

.login-page {
  display: flex;
  align-items: center;
  justify-content: center;

  &__left {
    width: 1020px;

    @media (max-width: 1440px) {
      & {
        width: 600px;

        img {
          width: 840px;
        }
      }
    }
  }

  &__panel {
    width: 791px;
    height: 631px;
  }

  &__right {
    position: relative;
  }
}

.panel {
  &__body {
    display: flex;
    justify-content: space-between;
  }

  &__inner {
    background-color: #e6eef8;
    border-radius: $border-radius;
    padding-right: 10px;
    padding-bottom: 10px;
  }

  &__footer {
    margin-top: 28px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 600;
  }

  &__left {
    margin-left: 27px;
    margin-right: 20px;
    flex: 1;

    ul {
      li {
        background: url("../../assets/icons/success_red.svg") 0 4px no-repeat;
        padding-left: 23px;
        font-weight: 600;

        & + li {
          margin-top: 20px;
        }
      }
    }
  }

  &__right {
    width: 386px !important;
    height: 496px;
    background-color: $color-white;
    border-radius: $border-radius;

    button {
      width: 230px;
      height: 37px;
      box-shadow: -4px -4px 12px rgba(253, 255, 255, 0.8),
        4px 4px 12px rgba(187, 195, 206, 0.6);
    }
  }

  &__title {
    font-size: 18px;
    color: $color-red;
    font-weight: 700;
    text-align: center;
    line-height: 21.94px;
    padding-top: 20px;
    padding-bottom: 28px;
  }

  &__slogan {
    text-align: center;
    font-weight: 700;
    margin-top: 20px;
  }
}

.panel-right {
  &__logo {
    text-align: center;
    padding-top: 17px;
    padding-bottom: 10px;
  }

  &__forgot-password {
    color: rgba(0, 0, 0, 0.3);
    cursor: pointer;
    font-size: 12px;
    text-decoration: underline;
    margin-top: 10px;
  }

  &__slogan {
    letter-spacing: 1px;
    font-size: 16px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 29px;
  }

  &__form {
    padding-left: 7px;
    padding-right: 7px;
    display: flex;
    flex-direction: column;
    align-items: center;

    input[type="password"],
    input[type="text"] {
      width: 100%;
      background: linear-gradient(0deg, #e6eef8, #e6eef8), #cfd8dc;
      border-radius: $border-radius;
      border: none;
      box-shadow: none;
      height: 48px;
      color: #90a4ae;
      font-weight: 700;
      padding: 8px 10px;
      outline: none;

      &::placeholder {
        color: #90a4ae;
        font-weight: 700;
      }

      & + input {
        margin-top: 8.52px;
      }
    }

    .policy {
      font-size: 12px;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 38px;
      display: flex;

      input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        min-width: 16px;
        height: 16px;
        background-color: #f5f5f5;
        border-radius: 2px;
        border: 1px solid #d9d9d9;
        cursor: pointer;
        margin-right: 10px;
        position: relative;

        &:checked:after {
          content: "";
          position: absolute;
          background: url("../../assets/icons/check.svg") no-repeat 1px 2px;
          border-radius: 2px;
          z-index: 100;
          width: 16px;
          height: 16px;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
        }
      }

      label {
        color: rgba(0, 0, 0, 0.3);
        display: flex;
      }
    }
  }

  input[type="text"]:disabled,
  input[type="password"]:disabled {
    opacity: 0.5;
  }

  &__col {
    width: 100%;
    position: relative;

    & + div {
      margin-top: 8.52px;
    }

    img {
      position: absolute;
      right: 9.94px;
      top: 4.94px;
      z-index: 1000;
    }
  }

  &--forgot {
    width: 464px;
    padding: 37.78px 20px 40px 20px;
    background-color: #e6eef8;
    height: 100%;

    .panel-right__inner {
      background-color: $color-white;
      border-radius: $border-radius;
      padding-bottom: 40px;
      padding-left: 21px;
      padding-right: 20px;

      .panel-right__slogan {
        margin-bottom: 10.74px;
      }

      .panel-right__slogan-secondary {
        color: rgba(0, 0, 0, 0.3);
        font-weight: 600;
        margin-bottom: 20.26px;
        line-height: 17px;
      }

      form {
        padding: 0;
      }
    }
  }
}
</style>
